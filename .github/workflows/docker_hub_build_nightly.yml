name: Bump Version, Build and Publish Docker Image

on:
  push:
    branches:
      - nightly

jobs:
  bump-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Set up Node.js
        uses: actions/setup-node@v4.1.0
        with:
          node-version: '16'

      - name: Bump version in package.json
        id: bump_version
        run: |
          current_version=$(jq -r '.version' package.json)
          new_version=$(npx semver $current_version -i patch) # Change to minor/major as needed
          echo "Bumping version from $current_version to $new_version"
          jq ".version = \"$new_version\"" package.json > package_tmp.json && mv package_tmp.json package.json
          echo "new_version=$new_version" >> $GITHUB_ENV
          
      - name: Commit and push new version
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore: bump version to ${{ env.new_version }}"
          git tag -a "v${{ env.new_version }}" -m "Release ${{ env.new_version }}"
          git push origin nightly
          git push origin "v${{ env.new_version }}" 

  build:
    needs: bump-version
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.7.1

      - name: Log in to Docker Hub
        run: echo ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }} | docker login -u ciuse99 --password-stdin

      - name: Build and Push Docker Image
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --cache-from type=registry,ref=ciuse99/suggestarr:cache \
            --cache-to type=registry,ref=ciuse99/suggestarr:cache,mode=max \
            -t ciuse99/suggestarr:nightly \
            -t ciuse99/suggestarr:${{ env.new_version }} \
            -f docker/Dockerfile . --push
