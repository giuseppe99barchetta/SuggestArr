name: Build and Publish Docker Image to Docker Hub

on:
  push:
    branches:
      - nightly

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runs-on: ubuntu-latest
          - platform: linux/arm64
            runs-on: ubuntu-24.04-arm
    runs-on: ${{ matrix.runs-on }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0

      - name: Log in to Docker Hub
        uses: docker/login-action@v3.7.0
        with:
          username: ciuse99
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Prepare platform slug
        id: prep
        run: echo "platform_slug=$(echo '${{ matrix.platform }}' | tr '/' '-')" >> $GITHUB_OUTPUT

      - name: Build and push platform image
        uses: docker/build-push-action@v6.19.2
        with:
          context: .
          file: docker/Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          tags: ciuse99/suggestarr:nightly-${{ steps.prep.outputs.platform_slug }}
          cache-from: |
            type=gha,scope=nightly-${{ matrix.platform }}
            type=registry,ref=ciuse99/suggestarr:cache
          cache-to: type=gha,scope=nightly-${{ matrix.platform }},mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            DOCKER_TAG=nightly
            VCS_REF=${{ github.sha }}

  merge:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3.7.0
        with:
          username: ciuse99
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0

      - name: Create and push multi-platform manifest
        run: |
          docker buildx imagetools create \
            -t ciuse99/suggestarr:nightly \
            ciuse99/suggestarr:nightly-linux-amd64 \
            ciuse99/suggestarr:nightly-linux-arm64

      - name: Clean up temporary platform tags
        run: |
          TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"ciuse99\",\"password\":\"${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}\"}" \
            https://hub.docker.com/v2/users/login/ | jq -r .token)
          for SLUG in linux-amd64 linux-arm64; do
            curl -s -X DELETE \
              -H "Authorization: Bearer ${TOKEN}" \
              "https://hub.docker.com/v2/repositories/ciuse99/suggestarr/tags/nightly-${SLUG}/" || true
          done
