name: Bump Version, Build and Publish Docker Image

on:
  push:
    branches:
      - main

jobs:
  bump-version:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump_version.outputs.new_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: '20'

      - name: Ensure Dependencies are Installed
        run: |
          npm install -g semver
          sudo apt-get install jq -y

      - name: Detect version bump type and bump version
        id: bump_version
        run: |
          cd client/

          current_version=$(jq -r '.version' package.json | sed 's/^v//')
          commit_msg=$(git log -1 --pretty=%B)

          if echo "$commit_msg" | grep -q "\[skip bump\]"; then
            echo "Skip bump detected â€” keeping current version v$current_version"
            echo "new_version=v$current_version" >> $GITHUB_OUTPUT
            echo "skip_bump=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          bump_type="patch"

          if echo "$commit_msg" | grep -q "BREAKING CHANGE\|feat!"; then
            bump_type="major"
          elif echo "$commit_msg" | grep -q "^feat"; then
            bump_type="minor"
          fi

          new_version=$(npx semver $current_version -i $bump_type)
          prefixed_version="v$new_version"

          echo "Detected bump type: $bump_type"
          echo "Bumping version from v$current_version to $prefixed_version"

          jq ".version = \"$prefixed_version\"" package.json > package_tmp.json && mv package_tmp.json package.json

          echo "new_version=$prefixed_version" >> $GITHUB_OUTPUT
          echo "skip_bump=false" >> $GITHUB_OUTPUT

      - name: Commit and push new version
        if: steps.bump_version.outputs.skip_bump != 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add client/package.json
          git commit -m "chore: bump version to ${{ steps.bump_version.outputs.new_version }}"

          git tag -a "${{ steps.bump_version.outputs.new_version }}" -m "Release ${{ steps.bump_version.outputs.new_version }}"

          git pull origin main --rebase
          git push origin main
          git push origin "${{ steps.bump_version.outputs.new_version }}"

  build:
    permissions:
      contents: read
    needs: bump-version
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runs-on: ubuntu-latest
          - platform: linux/arm64
            runs-on: ubuntu-24.04-arm
    runs-on: ${{ matrix.runs-on }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2

      - name: Pull latest changes
        run: git pull origin main

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0

      - name: Log in to Docker Hub
        uses: docker/login-action@v3.7.0
        with:
          username: ciuse99
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Prepare platform slug
        id: prep
        run: echo "platform_slug=$(echo '${{ matrix.platform }}' | tr '/' '-')" >> $GITHUB_OUTPUT

      - name: Build and push platform image
        uses: docker/build-push-action@v6.19.2
        with:
          context: .
          file: docker/Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          tags: ciuse99/suggestarr:${{ needs.bump-version.outputs.new_version }}-${{ steps.prep.outputs.platform_slug }}
          cache-from: |
            type=gha,scope=prod-${{ matrix.platform }}
            type=registry,ref=ciuse99/suggestarr:cache
          cache-to: type=gha,scope=prod-${{ matrix.platform }},mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            DOCKER_TAG=${{ needs.bump-version.outputs.new_version }}

  merge:
    permissions:
      contents: read
    needs: [bump-version, build]
    runs-on: ubuntu-latest

    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3.7.0
        with:
          username: ciuse99
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0

      - name: Create and push multi-platform manifest
        env:
          VERSION: ${{ needs.bump-version.outputs.new_version }}
        run: |
          docker buildx imagetools create \
            -t ciuse99/suggestarr:latest \
            -t ciuse99/suggestarr:${VERSION} \
            ciuse99/suggestarr:${VERSION}-linux-amd64 \
            ciuse99/suggestarr:${VERSION}-linux-arm64

      - name: Clean up temporary platform tags
        env:
          VERSION: ${{ needs.bump-version.outputs.new_version }}
        run: |
          TOKEN=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"ciuse99\",\"password\":\"${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}\"}" \
            https://hub.docker.com/v2/users/login/ | jq -r .token)
          for SLUG in linux-amd64 linux-arm64; do
            curl -s -X DELETE \
              -H "Authorization: Bearer ${TOKEN}" \
              "https://hub.docker.com/v2/repositories/ciuse99/suggestarr/tags/${VERSION}-${SLUG}/" || true
          done

  recreate-nightly:
    permissions:
      contents: write
    needs: merge
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6.0.2

      - name: Recreate nightly branch
        run: |
          git fetch origin
          git branch -D nightly || true
          git push origin --delete nightly || true
          git checkout -b nightly
          git push origin nightly
